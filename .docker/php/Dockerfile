# The Dockerfile is for creating images not containers.
FROM php:7.3.0-apache-stretch

MAINTAINER Chenda Mok (cmok@salesforce.com)

WORKDIR /app

COPY . /app

# COPY failed: Forbidden path outside the build context
# COPY failed: stat /var/lib/docker/tmp/docker-builder788906308/vhost.conf: no such file or directory
COPY .docker/php/vhost.conf /etc/apache2/sites-available/000-default.conf
COPY .docker/php/entrypoint.sh /app/entrypoint.sh

# Certificates are autogenerated
# https://github.com/MarvAmBass
# COPY server.crt /etc/apache2/ssl/server.crt
# COPY server.key /etc/apache2/ssl/server.key

# Build usefull aliases
RUN echo "export LS_OPTIONS='--color=auto'" >> ~/.bashrc
RUN echo "alias ls='ls $LS_OPTIONS'" >> ~/.bashrc
RUN echo "alias ll='ls $LS_OPTIONS -l'" >> ~/.bashrc
RUN echo "alias l='ls $LS_OPTIONS -lA'" >> ~/.bashrc

# Add required modules for SSL (these are disabled by default)
# COPY entrypoint.sh .
RUN chmod au+x /app/entrypoint.sh
# To store private & public key, generated automatically if not exist by /app/entrypoint.sh script
# RUN mkdir -p /app/certificate

# zlib zip 
# compile missing libs
# RUN docker-php-ext-install mysqli pdo pdo_mysql mbstring
RUN chown -R www-data:www-data /app
RUN a2enmod rewrite
RUN a2enmod ssl

EXPOSE 80
EXPOSE 443

# starting container process caused "exec: \"/app/entrypoint.sh\": stat /app/entrypoint.sh: no such file or directory": unknown
# ENTRYPOINT ["/app/entrypoint.sh"]

CMD ["/usr/sbin/apache2ctl", "-D", "FOREGROUND"]

#RUN service apache2 restart